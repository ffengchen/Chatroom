<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Operation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Assignment8_Server</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">Operation.java</span></div><h1>Operation.java</h1><pre class="source lang-java linenums">
import java.io.DataOutputStream;
import java.util.Arrays;
import java.util.Map;
import java.util.regex.Pattern;

/**
 * Processing center for messages come to the server.
 * */
<span class="nc" id="L10">public class Operation {</span>

  private static final String VALID_USERNAME_PATTERN = &quot;^[_a-zA-Z0-9]{3,12}$&quot;;
  private static final String SYSTEM_RESERVED_WORD = &quot;^[^A-Za-z0-9]*(all|admin)[^A-Za-z0-9]*$&quot;;
  private static final int MAXIMUM_CONNECTED_USER_NUM = 10;

  /**
   * Respond a connect message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username sent by the client.
   * @return a boolean value indicates the result of connection.
   * */
  public static boolean connectResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username) {
<span class="fc" id="L25">    String usernameStr = new String(username);</span>
<span class="fc" id="L26">    boolean successLogin = false;</span>
<span class="fc bfc" id="L27" title="All 2 branches covered.">    if (clients.containsKey(usernameStr)) {</span>
<span class="fc" id="L28">      new ConnectResponse(false, username, &quot;Username already exists!&quot;.getBytes())</span>
<span class="fc" id="L29">          .writeToStream(out);</span>
    }
<span class="pc bpc" id="L31" title="1 of 2 branches missed.">    else if (clients.size() &gt;= MAXIMUM_CONNECTED_USER_NUM) {</span>
<span class="nc" id="L32">      new ConnectResponse(false, username, &quot;The chatroom is full. Please wait for an available seat.&quot;.getBytes()).writeToStream(out);</span>
<span class="pc bpc" id="L33" title="2 of 4 branches missed.">    } else if (!Pattern.matches(VALID_USERNAME_PATTERN, usernameStr) || Pattern.matches(</span>
        SYSTEM_RESERVED_WORD, usernameStr)) {
<span class="nc" id="L35">      new ConnectResponse(false, username,</span>
          &quot;Username is invalid!\nPlease choose a username with 3 - 12 characters (_, a-z, A-Z, 0-9). 'all' and 'admin' are reserved by the system.&quot;
<span class="nc" id="L37">              .getBytes()).writeToStream(out);</span>
    } else {
<span class="fc" id="L39">      new ConnectResponse(true, username,</span>
<span class="fc" id="L40">          (&quot;Welcome, &quot; + usernameStr + &quot;. There are &quot; + clients.size() + &quot; other connected clients&quot;)</span>
<span class="fc" id="L41">              .getBytes()).writeToStream(out);</span>
<span class="fc" id="L42">      clients.put(new String(username), out);</span>
<span class="fc" id="L43">      System.out.format(usernameStr + &quot; is online now.\nOnline users(%d):\n&quot;, clients.size());</span>
<span class="fc" id="L44">      showOnlineUsers(clients);</span>
<span class="fc" id="L45">      successLogin = true;</span>
    }
<span class="fc" id="L47">    return successLogin;</span>
  }

  /**
   * Respond a insult message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username of the sender.
   * @param toUsername the username of the recipient.
   * */
  public static void insultResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username, byte[] toUsername) {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">    if (!clients.containsKey(new String(toUsername)) || !clients</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        .containsKey(new String(username))) {</span>
<span class="fc" id="L61">      new FailedMessage(&quot;Username is invalid.&quot;.getBytes()).writeToStream(out);</span>
    } else {
<span class="nc" id="L63">      SendInsultResponse sendInsultResponse = new SendInsultResponse(username, toUsername);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">      for (DataOutputStream dataOutputStream : clients.values()) {</span>
<span class="nc" id="L65">        sendInsultResponse.writeToStream(dataOutputStream);</span>
<span class="nc" id="L66">      }</span>
    }
<span class="fc" id="L68">  }</span>

  /**
   * Respond a direct message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username of the sender.
   * @param toUsername the username of the recipient.
   * @param message the content of the direct message.
   * */
  public static void directMsgResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username, byte[] toUsername, byte[] message) {
<span class="fc" id="L80">    String senderName = new String(username);</span>
<span class="fc" id="L81">    String recipientName = new String(toUsername);</span>
<span class="pc bpc" id="L82" title="1 of 4 branches missed.">    if (!clients.containsKey(senderName) || !clients.containsKey(recipientName)) {</span>
<span class="fc" id="L83">      new FailedMessage(&quot;Username is invalid&quot;.getBytes()).writeToStream(out);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    } else if (senderName.equals(recipientName)) {</span>
<span class="nc" id="L85">      new FailedMessage(&quot;Please do not try sending a msg to yourself.&quot;.getBytes())</span>
<span class="nc" id="L86">          .writeToStream(out);</span>
    } else {
<span class="nc" id="L88">      new DirectMessage(username, toUsername, message).writeToStream(clients.get(recipientName));</span>
    }

<span class="fc" id="L91">  }</span>

  /**
   * Respond a broadcast message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username of the sender.
   * @param message the content of the direct message.
   * */
  public static void broadcastResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username, byte[] message) {
<span class="fc bfc" id="L102" title="All 2 branches covered.">    if (!clients.containsKey(new String(username)) &amp;&amp; !Arrays</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        .equals(username, &quot;[Admin]&quot;.getBytes())) {</span>
<span class="fc" id="L104">      new FailedMessage(&quot;Sender Username is invalid.&quot;.getBytes()).writeToStream(out);</span>
    } else {
<span class="fc" id="L106">      BroadcastMessage boardCastMessage = new BroadcastMessage(username, message);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">      for (DataOutputStream dataOutputStream : clients.values()) {</span>
<span class="fc" id="L108">        boardCastMessage.writeToStream(dataOutputStream);</span>
<span class="fc" id="L109">      }</span>
    }

<span class="fc" id="L112">  }</span>

  /**
   * Respond a query message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username of the sender.
   * */
  public static void queryResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">    if (!clients.containsKey(new String(username))) {</span>
<span class="fc" id="L123">      new FailedMessage(&quot;Wrong username&quot;.getBytes()).writeToStream(out);</span>
    } else {
<span class="fc" id="L125">      new QueryResponse(clients.keySet()).writeToStream(out);</span>
    }
<span class="fc" id="L127">  }</span>

  /**
   * Respond a disconnect message.
   * @param out a data output stream pointing to the client.
   * @param clients a map storing all connected users.
   * @param username the username sent by the client.
   * */
  public static void disconnectResponse(DataOutputStream out, Map&lt;String, DataOutputStream&gt; clients,
      byte[] username) {
<span class="fc" id="L137">    String usernameStr = new String(username);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">    if (!clients.containsKey(new String(username))) {</span>
<span class="fc" id="L139">      new FailedMessage(&quot;Username doesn't exist.&quot;.getBytes()).writeToStream(out);</span>
    } else {
<span class="fc" id="L141">      new DisconnectResponse(&quot;Your are no longer connected.&quot;.getBytes()).writeToStream(out);</span>
<span class="fc" id="L142">      clients.remove(new String(username));</span>
<span class="fc" id="L143">      System.out.format(usernameStr + &quot; is offline now.\nOnline users(%d):\n&quot;, clients.size());</span>
<span class="fc" id="L144">      showOnlineUsers(clients);</span>
    }
<span class="fc" id="L146">  }</span>

  /**
   * Print out a list of online users.
   * @param clients a map of connected clients
   * */
  public static void showOnlineUsers(Map&lt;String, DataOutputStream&gt; clients) {
<span class="fc bfc" id="L153" title="All 2 branches covered.">    for (String client : clients.keySet()) {</span>
<span class="fc" id="L154">      System.out.println(client + &quot;\t&quot;);</span>
<span class="fc" id="L155">    }</span>
<span class="fc" id="L156">    System.out.println(&quot;--------------------&quot;);</span>
<span class="fc" id="L157">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>